---
// Events Slider Component
import { events } from './EventsList.astro';

// Helper to check if an event is in the past
const isPastEvent = (dateStr: string): boolean => {
	const eventDate = new Date(dateStr);
	const today = new Date();
	today.setHours(0, 0, 0, 0);
	return eventDate < today;
};

// Add isPast property to each event for rendering
const eventsWithStatus = events.map(event => ({
	...event,
	isPast: isPastEvent(event.date)
}));
---

<div class="events-slider" id="eventsSlider">
	<div class="slider-container">
		<button class="slider-arrow slider-arrow-prev" id="prevBtn" aria-label="Previous events">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<polyline points="15 18 9 12 15 6"/>
			</svg>
		</button>

		<div class="slider-track" id="sliderTrack">
			{eventsWithStatus.map((event) => (
				<div class={`event-card ${event.isPast ? 'event-card--past' : ''}`}>
					<div class="event-date">
						<span class="event-month">{event.date.split(' ')[0].substring(0, 3)}</span>
						<span class="event-day">{event.date.split(' ')[1].replace(',', '')}</span>
					</div>
					<div class="event-content">
						<h3 class="event-title">{event.title}</h3>
						{event.speaker && <p class="event-speaker">Featured Speaker: {event.speaker}</p>}
						<p class="event-description">{event.description}</p>
						<div class="event-meta">
							<span class="event-meta-item">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="12" cy="12" r="10"/>
									<polyline points="12 6 12 12 16 14"/>
								</svg>
								{event.timeSlots ? (
									event.timeSlots.map(slot => `${slot.label}: ${slot.time}`).join(' | ')
								) : event.time}
							</span>
							<span class="event-meta-item">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
									<circle cx="12" cy="10" r="3"/>
								</svg>
								{event.location}
							</span>
						</div>
						<div class="event-actions">
							{event.flyer && (
								<button
									class="event-show-more-btn"
									data-flyer={event.flyer.src}
									aria-label="View event flyer"
								>
									Show More
								</button>
							)}
							{event.isPast ? (
								<span class="event-past-badge">Past Event</span>
							) : (
								<a href={event.reserveLink} class="event-reserve-btn" target="_blank" rel="noopener noreferrer">
									Reserve Your Spot
								</a>
							)}
						</div>
					</div>
				</div>
			))}
		</div>

		<button class="slider-arrow slider-arrow-next" id="nextBtn" aria-label="Next events">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<polyline points="9 18 15 12 9 6"/>
			</svg>
		</button>
	</div>

	<div class="slider-dots" id="sliderDots"></div>
</div>

<!-- Flyer Modal -->
<div class="flyer-modal" id="flyerModal" aria-hidden="true">
	<div class="flyer-modal-backdrop" id="flyerModalBackdrop"></div>
	<div class="flyer-modal-content">
		<button class="flyer-modal-close" id="flyerModalClose" aria-label="Close modal">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<line x1="18" y1="6" x2="6" y2="18"/>
				<line x1="6" y1="6" x2="18" y2="18"/>
			</svg>
		</button>
		<img src="" alt="Event flyer" class="flyer-modal-image" id="flyerModalImage" />
	</div>
</div>

<style>
	.events-slider {
		position: relative;
		margin: 40px 0 0 0;
	}

	.slider-container {
		position: relative;
		display: flex;
		align-items: center;
		gap: 16px;
	}

	.slider-track {
		display: flex;
		gap: 20px;
		overflow-x: auto;
		scroll-snap-type: x mandatory;
		scroll-behavior: smooth;
		-webkit-overflow-scrolling: touch;
		padding: 8px 4px;
	 scrollbar-width: none;
	}

	.slider-track::-webkit-scrollbar {
		display: none;
	}

	.event-card {
		flex: 0 0 100%;
		scroll-snap-align: start;
		display: flex;
		gap: 20px;
		padding: 28px;
		background: #ffffff;
		border: 1px solid #e5e5e5;
		transition: border-color 0.2s ease, box-shadow 0.2s ease;
	}

	.event-card:hover {
		border-color: #3105e9;
		box-shadow: 0 4px 20px rgba(49, 5, 233, 0.15);
	}

	/* Past event styling */
	.event-card--past {
		opacity: 0.6;
	}

	.event-card--past:hover {
		border-color: #e5e5e5;
		box-shadow: none;
	}

	.event-card--past .event-date {
		background: #999;
	}

	.event-card--past .event-title {
		color: #999;
	}

	.event-date {
		flex-shrink: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		width: 70px;
		height: 70px;
		background: #3105e9;
		color: #ffffff;
		border-radius: 2px;
	}

	.event-month {
		font-family: 'Montserrat', sans-serif;
		font-size: 11px;
		font-weight: 600;
		letter-spacing: 0.05em;
		text-transform: uppercase;
	}

	.event-day {
		font-size: 24px;
		font-weight: 700;
		line-height: 1;
	}

	.event-content {
		flex: 1;
		min-width: 0;
	}

	.event-title {
		font-size: 20px;
		font-weight: 600;
		margin: 0 0 8px 0;
		color: #1a1a1a;
	}

	.event-speaker {
		font-family: 'Montserrat', sans-serif;
		font-size: 13px;
		font-weight: 500;
		color: #3105e9;
		margin: 0 0 12px 0;
	}

	.event-description {
		font-size: 15px;
		line-height: 1.6;
		color: #666;
		margin: 0 0 16px 0;
	}

	.event-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 16px;
	}

	.event-meta-item {
		display: flex;
		align-items: center;
		gap: 6px;
		font-family: 'Montserrat', sans-serif;
		font-size: 13px;
		color: #666;
	}

	.event-meta-item svg {
		flex-shrink: 0;
		color: #3105e9;
	}

	.event-reserve-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 12px 24px;
		font-family: 'Montserrat', sans-serif;
		font-size: 14px;
		font-weight: 700;
		color: #3105e9;
		background: transparent;
		border: 2px solid #3105e9;
		border-radius: 2px;
		text-decoration: none;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.event-reserve-btn:hover {
		background: #3105e9;
		color: #ffffff;
	}

	.event-past-badge {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 12px 24px;
		font-family: 'Montserrat', sans-serif;
		font-size: 14px;
		font-weight: 700;
		color: #999;
		background: transparent;
		border: 2px solid #999;
		border-radius: 2px;
	}

	.event-actions {
		display: flex;
		flex-direction: column;
		gap: 8px;
		margin-top: 16px;
	}

	.event-show-more-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 6px;
		padding: 12px 24px;
		font-family: 'Montserrat', sans-serif;
		font-size: 14px;
		font-weight: 700;
		color: #3105e9;
		background: transparent;
		border: 2px solid #3105e9;
		border-radius: 2px;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.event-show-more-btn:hover {
		background: #3105e9;
		color: #ffffff;
	}

	/* Flyer Modal */
	.flyer-modal {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: 9999;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
	}

	.flyer-modal[aria-hidden="false"] {
		opacity: 1;
		visibility: visible;
	}

	.flyer-modal-backdrop {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.85);
	}

	.flyer-modal-content {
		position: relative;
		max-width: 90vw;
		max-height: 90vh;
		z-index: 1;
	}

	.flyer-modal-close {
		position: absolute;
		top: -48px;
		right: -48px;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 40px;
		height: 40px;
		background: #ffffff;
		border: none;
		border-radius: 50%;
		cursor: pointer;
		color: #1a1a1a;
		transition: all 0.2s ease;
	}

	.flyer-modal-close:hover {
		background: #3105e9;
		color: #ffffff;
	}

	.flyer-modal-image {
		display: block;
		max-width: 100%;
		max-height: 85vh;
		border-radius: 4px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
	}

	.slider-arrow {
		flex-shrink: 0;
		display: none;
		align-items: center;
		justify-content: center;
		width: 44px;
		height: 44px;
		background: #ffffff;
		border: 1px solid #e5e5e5;
		border-radius: 50%;
		cursor: pointer;
		transition: all 0.2s ease;
		color: #666;
	}

	.slider-arrow:hover {
		background: #3105e9;
		border-color: #3105e9;
		color: #ffffff;
	}

	.slider-arrow:disabled {
		opacity: 0.3;
		cursor: not-allowed;
	}

	.slider-arrow:disabled:hover {
		background: #ffffff;
		border-color: #e5e5e5;
		color: #666;
	}

	.slider-dots {
		display: flex;
		justify-content: center;
		gap: 6px;
		margin-top: 28px;
	}

	.slider-dot {
		width: 40px;
		height: 4px;
		border-radius: 2px;
		background: #e5e5e5;
		border: none;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.slider-dot:hover {
		background: #b8a8f0;
	}

	.slider-dot.active {
		background: #3105e9;
		width: 48px;
	}

	/* Tablet */
	@media (min-width: 768px) {
		.event-card {
			flex: 0 0 calc(65% - 10px);
		}

		.slider-arrow {
			display: flex;
		}
	}

	/* Desktop */
	@media (min-width: 1024px) {
		.event-card {
			flex: 0 0 calc(45% - 14px);
		}
	}
</style>

<script>
	const track = document.getElementById('sliderTrack');
	const prevBtn = document.getElementById('prevBtn') as HTMLButtonElement | null;
	const nextBtn = document.getElementById('nextBtn') as HTMLButtonElement | null;
	const dotsContainer = document.getElementById('sliderDots');

	// Create dots
	const cards = track?.querySelectorAll('.event-card') ?? [];
	const totalSlides = cards.length;

	for (let i = 0; i < totalSlides; i++) {
		const dot = document.createElement('button');
		dot.className = 'slider-dot';
		dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
		if (i === 0) dot.classList.add('active');
		dot.addEventListener('click', () => scrollToSlide(i));
		dotsContainer?.appendChild(dot);
	}

	const dots = dotsContainer?.querySelectorAll('.slider-dot') ?? [];

	function getCardWidth(): number {
		if (cards.length === 0) return 0;
		const firstCard = cards[0] as HTMLElement;
		return firstCard.offsetWidth + 20; // card + gap
	}

	function scrollToSlide(index: number): void {
		if (!track) return;
		const cardWidth = getCardWidth();
		track.scrollTo({
			left: cardWidth * index,
			behavior: 'smooth',
		});
	}

	function updateDots(): void {
		if (!track || !prevBtn || !nextBtn) return;
		const scrollLeft = track.scrollLeft;
		const cardWidth = getCardWidth();
		const trackCenter = scrollLeft + (track.clientWidth / 2);

		// Find which card is most visible (center of viewport)
		let activeIndex = 0;
		let closestDistance = Infinity;

		cards.forEach((card, i) => {
			const htmlCard = card as HTMLElement;
			const cardCenter = (i * cardWidth) + (htmlCard.offsetWidth / 2);
			const distance = Math.abs(trackCenter - cardCenter);
			if (distance < closestDistance) {
				closestDistance = distance;
				activeIndex = i;
			}
		});

		// Clamp activeIndex to valid range
		activeIndex = Math.max(0, Math.min(totalSlides - 1, activeIndex));

		dots.forEach((dot, i) => {
			dot.classList.toggle('active', i === activeIndex);
		});

		// Update button states
		const isAtStart = scrollLeft < 10;
		const maxScroll = track.scrollWidth - track.clientWidth;
		const isAtEnd = scrollLeft >= maxScroll - 10;
		prevBtn.disabled = isAtStart;
		nextBtn.disabled = isAtEnd;
	}

	// Scroll handler
	track?.addEventListener('scroll', () => {
		updateDots();
	}, { passive: true });

	prevBtn?.addEventListener('click', () => {
		if (!track) return;
		const cardWidth = getCardWidth();
		const newIndex = Math.max(0, Math.round(track.scrollLeft / cardWidth) - 1);
		scrollToSlide(newIndex);
	});

	nextBtn?.addEventListener('click', () => {
		if (!track) return;
		const cardWidth = getCardWidth();
		const newIndex = Math.min(totalSlides - 1, Math.round(track.scrollLeft / cardWidth) + 1);
		scrollToSlide(newIndex);
	});

	// Initial update
	updateDots();

	// Recalculate on resize
	let resizeTimer: number | undefined;
	window.addEventListener('resize', () => {
		clearTimeout(resizeTimer);
		resizeTimer = window.setTimeout(() => {
			updateDots();
		}, 100);
	});

	// Flyer Modal functionality
	const modal = document.getElementById('flyerModal');
	const modalBackdrop = document.getElementById('flyerModalBackdrop');
	const modalClose = document.getElementById('flyerModalClose');
	const modalImage = document.getElementById('flyerModalImage') as HTMLImageElement | null;
	const showMoreBtns = document.querySelectorAll('.event-show-more-btn');

	function openModal(imageSrc: string): void {
		if (!modal || !modalImage) return;
		modalImage.src = imageSrc;
		modal.setAttribute('aria-hidden', 'false');
		document.body.style.overflow = 'hidden';
	}

	function closeModal(): void {
		if (!modal || !modalImage) return;
		modal.setAttribute('aria-hidden', 'true');
		modalImage.src = '';
		document.body.style.overflow = '';
	}

	showMoreBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			const flyerSrc = btn.getAttribute('data-flyer');
			if (flyerSrc) {
				openModal(flyerSrc);
			}
		});
	});

	modalClose?.addEventListener('click', closeModal);
	modalBackdrop?.addEventListener('click', closeModal);

	// Close on Escape key
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			closeModal();
		}
	});
</script>
